package com.ohgiraffers.chap01.section01;

import com.ohgiraffers.chap01.section01.model.Roles;
import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;

import java.sql.*;

/*
 * ê°ì²´ì§€í–¥(OOP)ê³¼ RDBì˜ íŒ¨ëŸ¬ë‹¤ì„ ì°¨ì´: ë™ì¼ ë°ì´í„°ì˜ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì™€ ë¬´ê²°ì„± ë¬¸ì œ
 *
 * `Application` í´ë˜ìŠ¤ëŠ” ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì—ì„œ RDBì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ `Roles` ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
 * ê°ì²´ì§€í–¥ì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ê°€ ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬ë˜ê¸°ë¥¼ ê¸°ëŒ€í•œë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, ë™ì¼í•œ `roleId`ë¥¼ ê°€ì§„ `Roles` ê°ì²´ëŠ” ë™ì¼í•œ ê°ì²´ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•˜ë©°, `roles == roles2`ê°€ `true`ë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
 * ì´ëŠ” ê°ì²´ ì‹ë³„ì„±(Identity)ê³¼ ê´€ë ¨ì´ ìˆë‹¤.
 *
 * ë°˜ë©´, ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤(RDB)ì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë”ë¼ë„ ë§¤ë²ˆ ìƒˆë¡œìš´ ë°ì´í„° í–‰(row)ì„ ë°˜í™˜í•œë‹¤.
 * `getRoles` ë©”ì„œë“œëŠ” ë™ì¼í•œ `roleId`ë¡œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ `Roles` ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ,
 * `roles`ì™€ `roles2`ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¸ì‹ëœë‹¤.
 *
 * ë”°ë¼ì„œ, ê°ì²´ì§€í–¥ì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ë¥¼ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬í•˜ë ¤ëŠ” ê²½í–¥ì´ ìˆë‹¤.
 * RDBì—ì„œëŠ” ë°ì´í„°ë¥¼ í–‰ ë‹¨ìœ„ë¡œ ì¡°íšŒí•˜ì—¬ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹ì´ ì¼ë°˜ì ì´ë‹¤.
 * ì´ ì°¨ì´ëŠ” ê°ì²´ì§€í–¥ê³¼ RDBì˜ íŒ¨ëŸ¬ë‹¤ì„ ì°¨ì´ë¥¼ ë³´ì—¬ì¤€ë‹¤.
 *
 * ğŸ“Œ ë¬´ê²°ì„±(Integrity) ë¬¸ì œ: ë™ì¼ ë°ì´í„°ì˜ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¸í•œ ìˆ˜ì • ë°˜ì˜ ë¬¸ì œ
 * RDBì—ì„œëŠ” ë™ì¼í•œ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¡°íšŒí•˜ë”ë¼ë„ ë™ì¼í•œ ë°ì´í„° í–‰(row)ì„ ë°˜í™˜í•˜ë©°, ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•œë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, `Roles` í…Œì´ë¸”ì—ì„œ `role_id=1`ì¸ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë©´ í•­ìƒ ë™ì¼í•œ ë°ì´í„°ê°€ ë°˜í™˜ëœë‹¤.
 * ê·¸ëŸ¬ë‚˜ `getRoles` ë©”ì„œë“œëŠ” ë™ì¼í•œ `roleId`ë¡œ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ `Roles` ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ,
 * ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤(ì˜ˆ: A ì¸ìŠ¤í„´ìŠ¤ì™€ B ì¸ìŠ¤í„´ìŠ¤)ê°€ ë§Œë“¤ì–´ì§„ë‹¤.
 * ì´ë¡œ ì¸í•´ ë¬´ê²°ì„± ë¬¸ì œê°€ ë°œìƒí•œë‹¤:
 * - A ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ `roleName`ì„ "Admin"ìœ¼ë¡œ ìˆ˜ì •í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•œ í›„,
 *   ë™ì¼í•œ `roleId`ë¡œ B ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ë©´ B ì¸ìŠ¤í„´ìŠ¤ëŠ” Aì˜ ìˆ˜ì • ì‚¬í•­ì„ ë°˜ì˜í•˜ì§€ ì•ŠëŠ”ë‹¤.
 * - ì´í›„ B ì¸ìŠ¤í„´ìŠ¤ë¥¼ `roleName`ì„ "User"ë¡œ ìˆ˜ì •í•˜ê³  ì €ì¥í•˜ë©´, A ì¸ìŠ¤í„´ìŠ¤ì˜ ìˆ˜ì • ì‚¬í•­ì´ ë®ì–´ì”Œì›Œì ¸ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•œë‹¤.
 *
 * ğŸ“Œ ë™ì‹œì„± ë¬¸ì œ(Concurrency Issue)ì™€ì˜ ê´€ë ¨ì„±
 * ìœ„ ë¬¸ì œëŠ” ë™ì‹œì„± ë¬¸ì œë¡œ í™•ì¥ë  ìˆ˜ ìˆë‹¤:
 * - ë™ì¼í•œ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤(Aì™€ B)ë¡œ ê´€ë¦¬í•˜ëŠ” ìƒí™©ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë‚˜ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ë™ì¼í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•  ë•Œ ë™ì‹œì„± ë¬¸ì œë¥¼ ìœ ë°œí•œë‹¤.
 * - ì˜ˆë¥¼ ë“¤ì–´, ìŠ¤ë ˆë“œ 1ì´ A ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ `roleName`ì„ "Admin"ìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ” ë™ì•ˆ,
 *   ìŠ¤ë ˆë“œ 2ê°€ B ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ `roleName`ì„ "User"ë¡œ ìˆ˜ì •í•˜ë©´, ë‘ ìŠ¤ë ˆë“œê°€ ì„œë¡œì˜ ë³€ê²½ ì‚¬í•­ì„ ë®ì–´ì“°ê²Œ ëœë‹¤.
 *   ì´ëŠ” ì „í˜•ì ì¸ **"Lost Update"** ë¬¸ì œì´ë‹¤.
 * - í˜„ì¬ ì½”ë“œì—ì„œëŠ” ë‹¨ì¼ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë™ì‘í•˜ì§€ë§Œ, ë™ì¼ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬í•˜ëŠ” ì„¤ê³„ ìì²´ê°€ ë™ì‹œì„± í™˜ê²½ì—ì„œ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ê°€ëŠ¥ì„±ì„ ë‚´í¬í•˜ê³  ìˆë‹¤.
 *
 * ğŸ“Œ ì¶”ê°€ ë¬¸ì œ: SQL ì˜ì¡´ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±
 * `getRoles` ë©”ì„œë“œ ë‚´ì—ì„œ SQL ì¿¼ë¦¬ì— ì§ì ‘ ì˜ì¡´í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒí•œë‹¤.
 * ì´ëŠ” ê°ì²´ì§€í–¥ ì½”ë“œê°€ RDBì˜ ìŠ¤í‚¤ë§ˆì™€ ì¿¼ë¦¬ì— ê°•í•˜ê²Œ ê²°í•©ë˜ì–´ ìš”êµ¬ì‚¬í•­ ë³€ê²½ ì‹œ SQL ìˆ˜ì •ì´ í•„ìš”í•˜ë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, `Roles` í…Œì´ë¸”ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ì´ ì¶”ê°€ë˜ê±°ë‚˜ ì»¬ëŸ¼ ì´ë¦„ì´ ë³€ê²½ë˜ë©´, `getRoles` ë©”ì„œë“œì˜ ì¿¼ë¦¬ì™€ ê°ì²´ ë§¤í•‘ ì½”ë“œë„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.
 * ì´ëŠ” ìœ ì§€ë³´ìˆ˜ì„±ì„ ì €í•˜ì‹œí‚¤ê³  ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì„ ë†’ì¸ë‹¤.
 * ë˜í•œ, ê°ì²´ë¥¼ ì‚¬ìš©í•  ë•Œ SQL ì¿¼ë¦¬ë¥¼ í™•ì¸í•´ì•¼ ê°ì²´ì— ì–´ë–¤ ê°’ì´ ë“¤ì–´ìˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤.
 *
 * ì´ëŸ¬í•œ ì°¨ì´ë¡œ ì¸í•´ ì„¤ê³„ì™€ êµ¬í˜„ì—ì„œ í˜¼ë€ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤:
 * - ê°ì²´ì§€í–¥ ê´€ì : ë™ì¼í•œ `roleId`ë¥¼ ê°€ì§„ `Roles` ê°ì²´ëŠ” ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•˜ë©°, ë¹„êµ ì‹œ `==`ë¡œ ë™ì¼ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
 * - RDB ê´€ì : ë™ì¼í•œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë”ë¼ë„ ë§¤ë²ˆ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•˜ë¯€ë¡œ, `roles == roles2`ê°€ `false`ë¡œ í‰ê°€ëœë‹¤.
 *   ì´ë¡œ ì¸í•´ ë™ì¼ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬í•˜ì—¬ ìˆ˜ì • ì‹œ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
 * ì´ë¡œ ì¸í•´ ë™ì¼í•œ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ê°€ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ê´€ë¦¬ë˜ì–´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
 * ë˜í•œ, ë™ì‹œì„± í™˜ê²½ì—ì„œëŠ” ì´ëŸ¬í•œ ë¬¸ì œê°€ ë” ì‹¬í™”ë˜ì–´ ë°ì´í„° ë¬´ê²°ì„±ì´ ê¹¨ì§ˆ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§„ë‹¤.
 * ì˜ˆë¥¼ ë“¤ì–´, ë™ì¼í•œ ê¶Œí•œ ê°ì²´ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ë©´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í•˜ê³ ,
 * ê°ì²´ ë¹„êµ ì‹œ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
 *
 * ì´ ì°¨ì´ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ì˜ ì£¼ì²´ì™€ ë™ì‘ì„ ì´í•´í•˜ëŠ” ë° í˜¼ë€ì„ ì´ˆë˜í•  ìˆ˜ ìˆë‹¤:
 * EX) ë™ì¼ ê¶Œí•œ ë¹„êµ: ê°ì²´ì§€í–¥ì—ì„œëŠ” `roles == roles2`ë¡œ ë™ì¼ì„±ì„ í™•ì¸í•˜ë ¤ í•˜ì§€ë§Œ, RDBì—ì„œëŠ” ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ì–´ ë¹„êµ ì‹¤íŒ¨.
 * EX) ê¶Œí•œ ìºì‹±: ë™ì¼í•œ ê¶Œí•œ ê°ì²´ë¥¼ ìºì‹±í•˜ì—¬ ì¬ì‚¬ìš©í•˜ë ¤ í•˜ì§€ë§Œ, ë§¤ë²ˆ ìƒˆë¡œìš´ ê°ì²´ê°€ ìƒì„±ë˜ì–´ ìºì‹± íš¨ê³¼ ìƒì‹¤.
 * EX) ê¶Œí•œ ìˆ˜ì •: A ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ê¶Œí•œ ì´ë¦„ì„ ìˆ˜ì •í•œ í›„, B ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë™ì¼ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë©´ Aì˜ ë³€ê²½ ì‚¬í•­ì´ ì†ì‹¤ëœë‹¤.
 * EX) ë™ì‹œ ìˆ˜ì •: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì¼ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•˜ë©´ "Lost Update" ë¬¸ì œë¡œ ë°ì´í„° ë¬´ê²°ì„±ì´ ê¹¨ì§„ë‹¤.
 */

public class Application {
    private static final HikariDataSource dataSource;

    static {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/JPA_LECTURE");
        config.setUsername("gorilla");
        config.setPassword("gorilla");
        dataSource = new HikariDataSource(config);
    }

    /*
     * ğŸ† 1ë‹¨ê³„: ë¬¸ì œ ì§ë©´í•˜ê¸° - "ê°™ì€ ë…€ì„ì¸ë°, ì™œ ë‹¤ë¥´ë‹¤ê³  í• ê¹Œ?"
     *
     * ğŸ’¡ ë¬¸ì œ ìƒí™©:
     * ìš°ë¦¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ IDê°€ 1ì¸ 'ê´€ë¦¬ì' ì—­í• ì„ ë‘ ë²ˆ ì¡°íšŒí–ˆë‹¤.
     * ìš°ë¦¬ì˜ ìƒì‹ìœ¼ë¡œëŠ” `roles`ì™€ `roles1`ì€ ê°™ì€ 'íšŒì›'ì´ë¯€ë¡œ, ë‘ ê°ì²´ëŠ” ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤ (`roles == roles1` -> true).
     * í•˜ì§€ë§Œ ê²°ê³¼ëŠ” `false` ì…ë‹ˆë‹¤. ì™œì¼ê¹Œìš”?
     *
     * ğŸ’¡ íŒ¨ëŸ¬ë‹¤ì„ ë¶ˆì¼ì¹˜ 1: ê°ì²´ì˜ ë™ì¼ì„±(Identity) vs DBì˜ ë™ë“±ì„±(Equality)
     * - ê°ì²´ì§€í–¥ ì„¸ìƒ: `==` ë¹„êµëŠ” ë‘ ê°ì²´ê°€ ë©”ëª¨ë¦¬ ìƒì—ì„œ 'ê°™ì€ ì¡´ì¬'ì¸ì§€ë¥¼ ë¬»ëŠ”ë‹¤.
     * - ë°ì´í„°ë² ì´ìŠ¤ ì„¸ìƒ: `role_id = 1` ì´ë¼ëŠ” ì¡°ê±´ì€ 'ê°’ì´ ê°™ì€ ë°ì´í„°'ë¥¼ ì˜ë¯¸í•œë‹¤.
     *
     * JDBCë¥¼ ì‚¬ìš©í•˜ë©´, DBì—ì„œ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ `Roles` ê°ì²´ë¥¼ ë©”ëª¨ë¦¬ì— ë§Œë“¤ê¸° ë•Œë¬¸ì—,
     * ê°’ì€ ê°™ì§€ë§Œ(ë™ë“±ì„±), ì„œë¡œ ë‹¤ë¥¸ ì¡´ì¬(ë™ì¼ì„± X)ê°€ ë˜ì–´ë²„ë¦°ë‹¤.
     *
     * ğŸ¤” ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?
     * ë§Œì•½ `roles` ê°ì²´ì˜ ì´ë¦„ì„ ë°”ê¾¸ê³  DBì— ì €ì¥í•œ ë’¤, ì•„ë¬´ê²ƒë„ ëª¨ë¥´ëŠ” `roles1` ê°ì²´ë¥¼ ë‹¤ì‹œ ì €ì¥í•˜ë©´
     * `roles`ì˜ ë³€ê²½ì‚¬í•­ì´ ë®ì–´ì”Œì›Œì§€ëŠ” ë”ì°í•œ ë°ì´í„° ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. (Lost Update ë¬¸ì œ)
     *
     * -> "JPAëŠ” ì–´ë–»ê²Œ ì´ ë¬¸ì œë¥¼ í•´ê²°í• ê¹Œìš”? ì´ ì§ˆë¬¸ì˜ ë‹µì„ ì°¾ì•„ê°€ëŠ” ê²ƒì´ ì´ë²ˆ ëª¨ë“ˆì˜ í•µì‹¬ì´ë‹¤."
     */
    public static void main(String[] args) throws SQLException {
        /* ë™ì¼ì„± ë³´ì¥ ë¬¸ì œ */
        Roles roles = getRoles(1);
        Roles roles1 = getRoles(1);
        System.out.println(roles);
        System.out.println(roles1);
        System.out.println("IDê°€ 1ì¸ ë‘ Role ê°ì²´ëŠ” ê³¼ì—° ê°™ì€ ì¡´ì¬ì¼ê¹Œìš”? -> " + (roles == roles1));

    }

    private static Roles getRoles(int roleId) {
        /* SQLì— ì˜ì¡´í•˜ì—¬ ê°œë°œ */
        String sql = "SELECT role_id, role_name FROM roles WHERE role_id = ?";

        // try-with-resourcesë¡œ ìì› ìë™ ê´€ë¦¬
        try (Connection con = dataSource.getConnection();
             PreparedStatement pstmt = con.prepareStatement(sql)) {

            // íŒŒë¼ë¯¸í„° ì„¤ì •ìœ¼ë¡œ SQL ì¸ì ì…˜ ë°©ì§€
            pstmt.setInt(1, roleId);
            ResultSet rset = pstmt.executeQuery();
            if (rset.next()) {
                Roles role = new Roles();
                role.setRoleId(rset.getInt("role_id"));
                role.setRoleName(rset.getString("role_name"));
                return role;
            } else {
                // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° null ë°˜í™˜ (ë˜ëŠ” ì˜ˆì™¸ ì²˜ë¦¬)
                return null;
            }
        } catch (SQLException e) {
            // ì˜ˆì™¸ë¥¼ ë˜í•‘í•˜ì—¬ ìƒìœ„ í˜¸ì¶œìì—ê²Œ ì „ë‹¬
            throw new RuntimeException("Failed to retrieve role with role_id=" + roleId, e);
        }
    }

}
